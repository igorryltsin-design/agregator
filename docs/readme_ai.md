# Классический поиск и AI-поиск в Agregator

Документ подробно описывает работу двух поисковых режимов: классического и AI-режима.

## 1. Общая схема поиска

В Agregator есть два режима:

1. **Классический поиск**  
   Быстрый отбор по полям БД, тегам и фильтрам.
2. **AI-поиск**  
   Многошаговый конвейер: расширение запроса, подбор кандидатов, формирование ответа с источниками.

## 2. Классический поиск

### 2.1 Назначение

Используется для оперативного поиска документов по:

- названию;
- автору;
- ключевым словам;
- тегам;
- временным и типовым фильтрам.

### 2.2 Типовые endpoint-ы

- `GET /api/search`
- `GET /api/search_v2`

### 2.3 Фильтры

- `q` - строка запроса;
- `type` - тип материала;
- `collection_id` - ограничение по коллекции;
- `year_from` / `year_to`;
- `tag=key=value` (может повторяться);
- пагинация (`limit`, `offset` в расширенном варианте).

## 3. AI-поиск

### 3.1 Назначение

AI-поиск решает вопрос "найди и объясни", а не только "найди документ".

Пайплайн включает:

1. расширение/нормализацию запроса;
2. подбор кандидатов по метаданным и текстовым сигналам;
3. построение сниппетов и источников;
4. генерацию ответа через LLM;
5. возврат результата с привязкой к документам.

### 3.2 Базовые endpoint-ы

- `POST /api/ai-search` - синхронный ответ;
- `POST /api/ai-search/stream` - потоковый режим (progress + result);
- `POST /api/ai-search/feedback` - пользовательский feedback.

### 3.3 Основные параметры AI-запроса

- `query` - исходный вопрос;
- `top_k` - желаемое число результатов;
- `deep_search` - углубленный анализ контента;
- `max_candidates` - размер пула кандидатов;
- `use_rag` - включение RAG-контура;
- фильтры коллекций/типов/лет/тегов.

## 4. Источники и прозрачность ответа

AI-ответ должен сопровождаться:

- списком документов-источников;
- сниппетами/фрагментами;
- служебными предупреждениями (если есть риск низкой достоверности).

Рекомендация для пользователей:

- всегда сверять критичные факты с источниками;
- использовать фильтры коллекций для повышения релевантности.

## 5. Производительность

На скорость AI-поиска влияют:

- latency LLM endpoint-а;
- размер кандидатов;
- включение deep/full-text режимов;
- качество и объем индексированного текста.

Оптимизация:

- ограничивать `max_candidates`;
- использовать кэши;
- контролировать тяжелые запросы в метриках.

## 6. Качество результатов

Рекомендуемые практики:

- регулярно чистить шумовые/дублирующиеся данные;
- поддерживать качество OCR;
- использовать feedback-цикл;
- запускать контрольные запросы после релизов.

## 7. Границы применения AI-ответов

- AI-ответ является вспомогательным.
- Для отчетов, публикаций и управленческих решений необходимо подтверждение по первоисточникам.

## 8. Связанные документы

- `docs/ai_search_operations.md`
- `docs/admin_handbook.md`
- `docs/architecture.md`
