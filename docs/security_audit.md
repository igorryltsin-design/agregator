# Аудит безопасности Agregator

Документ фиксирует типовые зоны риска и рекомендации по повышению безопасности окружения.

## 1. Область проверки

- аутентификация и авторизация;
- хранение секретов;
- валидация входных данных;
- API-контуры повышенной стоимости (AI/LLM);
- CORS и cookie-политики;
- журналирование и обработка ошибок.

## 2. Ключевые риски и рекомендации

### 2.1 Секреты и `.env`

**Риск:** утечка ключей API, паролей, токенов.  
**Рекомендации:**

- не хранить реальные `.env` в Git;
- использовать отдельные секреты на каждое окружение;
- ротировать ключи после инцидентов.

### 2.2 Отсутствие rate limiting для AI-endpoint-ов

**Риск:** перерасход ресурсов и деградация сервиса при всплеске запросов.  
**Рекомендации:**

- добавить лимиты на `/api/ai-search`, `/api/doc-chat/*`;
- применить квоты по пользователю/роли;
- включить алерты по аномальному росту нагрузки.

### 2.3 Неполная схема валидации входных данных

**Риск:** нестабильность API, логические ошибки, повышение attack surface.  
**Рекомендации:**

- ввести схему валидации payload-ов (Pydantic/marshmallow);
- стандартизировать ответы об ошибках;
- покрыть критичные endpoint-ы контрактными тестами.

### 2.4 Сессионная безопасность

**Рекомендации:**

- `SESSION_COOKIE_HTTPONLY=true`;
- `SESSION_COOKIE_SAMESITE=Lax`;
- `SESSION_COOKIE_SECURE=true` в HTTPS-среде;
- ограничение срока жизни сессии и принудительный logout по неактивности.

## 3. Базовый hardening checklist

- [ ] `.env` и секреты исключены из Git.
- [ ] Настроены сильные пароли/ротация ключей.
- [ ] Включен rate limiting для AI endpoint-ов.
- [ ] Добавлена централизованная валидация входных данных.
- [ ] Ограничен доступ к административным endpoint-ам.
- [ ] Настроено резервное копирование и проверка восстановления.
- [ ] Реализован аудит действий администраторов.

## 4. Эксплуатационные меры

- вести журнал изменений конфигурации;
- разграничивать dev/stage/prod ключи;
- регулярно обновлять зависимости;
- анализировать логи на повторяющиеся ошибки авторизации и AI-контуров.

## 5. Рекомендуемые следующие шаги

1. Внедрить rate limiting.
2. Внедрить схему валидации payload-ов.
3. Формализовать политику ротации секретов.
4. Добавить security-smoke в релизный pipeline.
