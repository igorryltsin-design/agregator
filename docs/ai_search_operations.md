# Эксплуатация AI-поиска (AI Search Operations)

Документ фиксирует практики эксплуатации AI-поиска: мониторинг, кеши, обратная связь, обслуживание и диагностика.

## 1. Назначение AI-поиска

AI-поиск расширяет классический поиск:

- подбирает релевантные документы и фрагменты;
- формирует ответ на естественном языке;
- показывает источники и служебные сигналы качества.

## 2. Рабочие компоненты

- endpoint-ы AI-поиска (`/api/ai-search`, `/api/ai-search/stream`);
- таблицы кэшей и метрик (`ai_search_*`);
- внешние LLM endpoint-ы;
- служебные задания очистки и переиндексации.

## 3. Кэширование

### 3.1 Что кэшируется

- сниппеты для повторяющихся запросов;
- промежуточные AI-результаты;
- агрегаты обратной связи.

### 3.2 Ключевые параметры

- `AI_SNIPPET_CACHE_TTL_HOURS`
- `AI_SNIPPET_CACHE_SWEEP_INTERVAL_HOURS`
- `AI_FEEDBACK_TTL`

### 3.3 Очистка

- плановая (по расписанию);
- ручная через административные endpoint-ы;
- аварийная при деградации качества.

## 4. Обратная связь и обучение весов

Система может собирать пользовательский feedback:

- клики;
- положительные/отрицательные оценки;
- шумовые сигналы.

После накопления данных запускается пересчет весов:

- `POST /api/admin/ai-search/feedback/train`
- мониторинг статуса: `GET /api/admin/ai-search/feedback/status`

## 5. Метрики качества и производительности

### 5.1 Рекомендуемые показатели

- `total_ms` (общее время ответа);
- длительность этапов (`llm_*`, `rag_*`, `snippet_*`);
- `rag_fallback` (доля fallback);
- `rag_hallucination_warning` (доля предупреждений);
- среднее число источников в ответе.

### 5.2 Пороговые сигналы

- постоянный рост `total_ms` -> проверить LLM latency и размер кандидатов;
- рост fallback > 10% -> проверить индекс и качество извлеченного текста;
- рост warning-метрик -> проверить корректность источников и промпт-контур.

## 6. Регламент обслуживания

### Ежедневно

- контроль метрик AI-поиска;
- проверка доступности LLM endpoint-ов;
- проверка ошибок в логах.

### Еженедельно

- выборочная проверка релевантности выдачи;
- ревизия ключевых запросов;
- контроль размеров таблиц кэша.

### Ежемесячно

- пересмотр параметров TTL/лимитов;
- анализ накопленного feedback;
- обновление эксплуатационных порогов.

## 7. Типовые проблемы и действия

- **Пустой AI-ответ:** проверить LLM endpoint, ключ, timeout, статус модели.
- **Долгий ответ:** уменьшить `max_candidates`, проверить нагрузку на LLM.
- **Слабая релевантность:** проверить качество исходного текста/OCR и веса feedback-модели.
- **Частый fallback:** проверить готовность RAG-контекста и индекса.

## 8. Полезные endpoint-ы

- `POST /api/ai-search`
- `POST /api/ai-search/stream`
- `POST /api/ai-search/feedback`
- `GET /api/admin/ai-search/metrics`
- `DELETE /api/admin/ai-search/metrics`
- `POST /api/admin/ai-search/feedback/train`
- `GET /api/admin/ai-search/feedback/model`
- `GET /api/admin/ai-search/feedback/status`

## 9. Рекомендации по надежности

- использовать несколько LLM endpoint-ов с fallback;
- задавать разумные таймауты и ретраи;
- отделять пользовательский трафик от админских тяжелых задач;
- иметь контрольный набор запросов для smoke-проверки после релиза.
