# Руководство администратора Agregator

Документ описывает повторяющиеся сценарии эксплуатации, необходимые роли и контрольные списки. Используйте его во время обучения администраторов и как справочник при передаче проекта в сопровождение.

## 1. Политика ролей и доступов
- **Администратор** — полный доступ к настройкам, коллекциям, очередям задач, API-ключам.
- **Модератор** — управление библиотекой и метаданными, просмотр логов, запуск фоновых задач, без прав на изменение системных параметров.
- **Наблюдатель** — доступ только к каталогу и поиску.

> Создавайте персональные учётные записи; дежурные логины с общим паролем запрещены. Используйте `/admin/users` или API `/api/admin/users`.

## 2. Типовые рабочие процессы

### 2.1 Импорт и каталогизация контента
1. Перетащите файлы в каталог `library` или используйте UI (`/app/import`).
2. Проверьте очередь фоновых задач (`/admin/tasks`), дождитесь завершения OCR и индексации.
3. Используйте фасеты «Авторы», «Годы», «Теги» для проверки автоматической классификации.
4. При необходимости добавьте пользовательские метки, сгруппируйте файлы в коллекции.
5. Выполните выборочный поиск, чтобы убедиться в доступности новых документов в выдаче.

### 2.2 Отладка RAG и AI-поиска
1. Перейдите в `/admin/settings/ai` и убедитесь, что LLM подключён.
2. Запустите `scripts/rag_smoke.py` или кнопку «Диагностика» в UI, чтобы проверить скорость ответов.
3. При высокой доле предупреждений *«вопрос вне контекста»* выполните `scripts/rag_index.py rebuild`.
4. Отслеживайте статистику в `/api/admin/ai-search/metrics` или на панели «AI метрики».
5. При необходимости скорректируйте веса rerank'а (`/admin/settings/ai-feedback`).

### 2.3 Управление голосовыми транскрипциями
1. Убедитесь, что в `.env` включены `TRANSCRIBE_ENABLED` и `TRANSCRIBE_MODEL_PATH`.
2. Добавьте или обновите модели Whisper (`docker cp` или монтирование каталогов).
   - При первом запуске Agregator загрузит модель с Hugging Face автоматически; для оффлайн-стенда заранее выполните
     ```bash
     python -m huggingface_hub download Systran/faster-whisper-small \
       --local-dir models/faster-whisper/Systran__faster-whisper-small \
       --local-dir-use-symlinks False
     ```
   - Убедитесь, что файлы `model.bin*` >1 МБ. Сообщение лога `Unsupported model binary version` означает, что остались плейсхолдеры git-lfs — скачайте модель заново.
3. Проверяйте статус задач в разделе «Импорт», фильтруя по типу «Аудио».
4. Для массовой переобработки выполните:
   ```bash
   docker compose exec agregator python scripts/retranscribe_audio.py --collection <id>
   ```
5. После завершения транскрипций экспортируйте результат в CSV (`/admin/reports/audio`).

### 2.4 Резервное копирование и перенос
1. Ежедневно запускайте `scripts/export_aiword.sh /app/backups --zip`.
2. Дублируйте `catalogue.db`, `runtime_settings.json`, `logs/` и `library/` на внешний носитель.
3. Для контейнеров сохраняйте образ:
   ```bash
   docker save -o agregator-$(date +%Y%m%d).tar agregator:amd64
   ```
4. Проверяйте целостность архивов (`tar -tzf`) и наличие контрольной суммы (`sha256sum`).

### 2.5 Обновление приложения
1. Создайте резервную копию (см. процесс выше).
2. Установите новую версию (команда `docker compose pull` или `git fetch && git checkout <tag>`).
3. Запустите миграции/подготовку:
   ```bash
   docker compose run --rm agregator python scripts/post_upgrade.py
   ```
4. Перезапустите сервис и проверяйте:
   - Статус фоновых задач (`/admin/tasks/status`).
   - Поиск и RAG на тестовых запросах.
   - Логи `logs/agregator.log` на ошибки.
5. Зафиксируйте изменения в журнале администрирования.

### 2.6 Поддержка пользователей
1. Приёмы обращений — почта, чат, helpdesk. Используйте шаблон тикета (ID документа, шаги до ошибки).
2. Проверяйте логи (`logs/`) по временной метке проблемы.
3. Если баг воспроизводится, создайте issue в трекере с указанием версии, окружения, параметров запроса.
4. Если требуется экспорт, используйте `scripts/export_reports.py --user <id>`.

## 3. Контрольные списки

### Ежедневно
- [ ] Проверить `/admin/tasks/status` на зависшие задачи.
- [ ] Просмотреть логи `logs/agregator.log` на ошибки `ERROR`/`CRITICAL`.
- [ ] Убедиться, что резервная копия `scripts/export_aiword.sh` завершилась успешно.
- [ ] Проверить доступность LLM (`/admin/settings/ai` → «Тест соединения»).

### Еженедельно
- [ ] Проводить выборочный аудит метаданных (несколько документов на коллекцию).
- [ ] Запускать `scripts/rag_smoke.py` и фиксировать среднее время ответа.
- [ ] Обновлять модели Whisper/LLM при необходимости.
- [ ] Сверять свободное место на диске (особенно для `library/` и `backups/`).

### Ежемесячно
- [ ] Проверить пользователей и роли, выключить неактуальные учётные записи.
- [ ] Пересмотреть политики доступа к коллекциям и ACL.
- [ ] Провести восстановление из резервной копии на стенде и подтвердить успешность.
- [ ] Обновить документацию (README, этот документ, `docs/setup_guide.md`) с учётом изменений в конфигурации.

### Перед обновлением версии
- [ ] Создать свежую резервную копию и сохранить хеш-суммы.
- [ ] Протестировать обновление и миграции на staging.
- [ ] Подготовить план отката (хранение предыдущего образа/артефакта).
- [ ] Уведомить пользователей о времени простоя.

### После инцидента
- [ ] Зафиксировать причину и шаги восстановления в журнале.
- [ ] Создать issue/задачу на устранение первопричины.
- [ ] Обновить инструкции, если инцидент связан с пробелом в документации.
- [ ] Провести ретроспективу с командой.

## 4. Журнал администрирования
- Ведите отдельный документ (Confluence/Notion/Google Doc) с датами, версиями, ключевыми событиями.
- Фиксируйте: обновления ПО, изменения настроек, нештатные ситуации и отработанные инциденты.
- При передаче проекта обновляйте контактный лист ответственных и график дежурств.

## 5. Подготовка демонстрации и презентаций
- Используйте `docs/training_resources.md` (раздел «Сценарий презентации Agregator (30 минут)») как основу для живых выступлений.
- Подготовьте демо-окружение заранее: заполненная библиотека (PDF, презентации, изображения, аудио), настроенный LLM и модели Whisper, прогретый кэш поиска.
- Пройдите чек-лист функций перед мероприятием: коллекции, импорт, поиск, AI-панель, голосовой ввод, граф, статистика, AiWord, управление пользователями.
- Держите под рукой резервный план: запись демо на видео, слайды со скриншотами ключевых экранов, ссылку на GitHub.
- Зафиксируйте результат презентации в журнале администрирования (к кому обращались, какие вопросы задавали, нужны ли доработки).

## 6. Дополнительные ресурсы
- `docs/setup_guide.md` — подробные шаги по установке и конфигурации.
- `docs/training_resources.md` — программа обучения и ссылки на записи.
- `docs/ai_search_operations.md` — эксплуатация AI-поиска и мониторинг.
- `docs/deployment.md` — сценарии деплоя и автоматизации.

Храните документ в актуальном состоянии, обновляйте чек-листы при появлении новых модулей, интеграций и регламентов.
