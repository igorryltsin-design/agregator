# Архитектура Agregator

Agregator построен как локальное веб-приложение, сочетающее Flask backend, статические SPA-фронтенды и очередь фоновых задач для ресурсоёмких операций (сканирование библиотеки, OCR, аудио). Ниже — сжатый обзор компонентов и их взаимодействия.

## Основные компоненты
- **Web UI** — собирается в `frontend/dist` и `AiWord/dist`, отдаётся напрямую Flask-приложением.
- **Flask API** (`app.py`, `routes.py`) — обслуживает HTTP-запросы, аутентификацию, REST API и отдаёт статику.
- **Слой сервисов** (`agregator/services/*`) — инкапсулирует интеграции (LLM, поиск, фасеты, кеши, HTTP-клиент).
- **Очередь задач** (`TaskQueue`) — выполняет долгие операции в потоках, отслеживает прогресс в таблице `TaskRecord`.
- **Хранилище** — SQLite (`catalogue.db`) для метаданных плюс директория материалов (`SCAN_ROOT`).
- **LLM/внешние сервисы** — LM Studio, OpenAI-совместимые API, OCR/FFmpeg и т.д.

## Схема взаимодействия
```
+-----------+       HTTPS       +---------------------+
|  Браузер  |  <------------->  |  Flask / WSGI-прил. |
+-----------+                   +---------------------+
                                       | SQLAlchemy
                                       v
                                +---------------+
                                |  SQLite (DB)  |
                                +---------------+
                                       |
        +-------------------------------+-----------------------------+
        |                               |                             |
        v                               v                             v
+---------------+              +------------------+           +--------------------+
|  TaskQueue    |  ---> spawn  | Background jobs  |   HTTP    | LLM/внешние сервисы|
| (in-memory)   |              |  (OCR, импорт)   |<--------->|  (LM Studio, etc.) |
+---------------+              +------------------+           +--------------------+
        |
        v
+------------------+
| Runtime settings |
|  + кеши (Redis)* |
+------------------+
```
\* Redis не обязателен: кеши и настройки по умолчанию хранятся файлово/памятно.

## Потоки данных
### Импорт и сканирование
1. Пользователь загружает файл или инициирует сканирование каталога (`/import/start`, `/scan/start`).
2. Flask регистрирует задачу в `TaskRecord` и кладёт её в `TaskQueue`.
3. Фоновый worker извлекает текст/метаданные (OCR, Whisper, LLM), регистрирует теги, обновляет БД и SearchCache.
4. UI опрашивает прогресс по API (`/tasks/<id>`), отображает статус и ошибки.

### Поиск и фасеты
1. UI вызывает `/search` или `/search/ai`.
2. SearchService проверяет SearchCache и кеш фасетов.
3. При необходимости выполняется полнотекстовый поиск по SQLite FTS и реранжирование через LLM.
4. Результат возвращается с фасетами, превью и ссылками на файлы.

### Аутентификация и RBAC
- Пользователи/роли (`admin`, `editor`, `viewer`) живут в SQLite.
- Сессии хранятся в защищённых cookies (HMAC, `FLASK_SECRET_KEY`).
- ACL коллекций контролируются через `CollectionMember` и проверяются в декораторах `require_role`/`require_collection_access`.

## Развёртывание
- Базовый образ собирается многостадийным `Dockerfile` (Node → Python). Результат — `python:3.11-slim` + статические фронтенды.
- Compose-файлы: `docker-compose.yml` (production-like), `docker-compose.dev.yml` (горячая перезагрузка), `docker-compose.test.yml` (юнит-тесты).
- Переменные окружения описаны в `docker/app.env`, `docker/app.dev.env`, `docker/app.test.env` и могут переопределяться через `docker-compose.override.yml`.

Дополнительные детали по сборке и конфигурации смотрите в `docs/deployment.md`.
