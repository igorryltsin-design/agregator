# Руководство по установке Agregator

Документ предназначен для администраторов и инженеров, которые поднимают Agregator с нуля.  
Описаны два сценария: локальный запуск (Python) и Docker Compose.

## 1. Минимальные требования

### 1.1 Аппаратные

- CPU: от 4 ядер (рекомендуется 6+ для OCR/AI-нагрузки)
- RAM: от 8 ГБ (рекомендуется 16 ГБ для стабильной работы AI-поиска)
- Диск: от 20 ГБ + место под библиотеку файлов

### 1.2 Программные

- Python 3.11+
- Node.js 20+ и npm
- Git
- Опционально (для полного функционала):
  - `ffmpeg`
  - `tesseract-ocr`
  - `poppler-utils`
- Для контейнерного режима:
  - Docker 24+
  - Docker Compose v2

## 2. Подготовка проекта

```bash
git clone <url-репозитория>
cd Agregator
cp .env.example .env
```

Отредактируйте `.env` перед запуском:

- `FLASK_SECRET_KEY` - обязательный секрет
- `SCAN_ROOT` - путь к библиотеке файлов
- `DEFAULT_ADMIN_USER`, `DEFAULT_ADMIN_PASSWORD` - первичный доступ
- `LMSTUDIO_*` - если подключается внешний/локальный LLM

## 3. Сценарий A: запуск без Docker

### 3.1 Установка backend-зависимостей

```bash
python -m venv .venv
source .venv/bin/activate  # Windows: .venv\Scripts\activate
pip install --upgrade pip
pip install -r requirements.txt
```

### 3.2 Сборка frontend-приложений

```bash
npm --prefix frontend install
npm --prefix frontend run build
npm --prefix AiWord install
npm --prefix AiWord run build
```

### 3.3 Запуск

```bash
python app.py
```

Приложение доступно по адресу `http://localhost:5050/app`.

## 4. Сценарий B: запуск через Docker Compose

### 4.1 Базовый запуск

```bash
docker compose build
docker compose up -d
docker compose logs -f agregator
```

### 4.2 Проверка

- URL: `http://localhost:5050/app`
- Статус API: `GET /api/auth/me` (после авторизации)
- Логи контейнера не должны содержать повторяющиеся `ERROR`

## 5. Первая инициализация системы

1. Войти под администратором.
2. Проверить системные настройки в UI.
3. Добавить тестовый документ.
4. Убедиться, что:
   - карточка документа отображается;
   - текст извлечен;
   - документ находится поиском;
   - AI-поиск возвращает ответ (если подключен LLM).

## 6. Проверка OCR и транскрибации

### OCR

- Убедитесь, что системные пакеты установлены.
- Загрузите сканированный PDF.
- Проверьте наличие текста/сниппетов в карточке.

### Транскрибация

- `TRANSCRIBE_ENABLED=true`
- Настроен путь к модели в `TRANSCRIBE_MODEL_PATH`
- Загрузите короткий аудиофайл и дождитесь завершения задачи.

## 7. Типовые проблемы

- **Сервис не стартует:** проверить `.env`, версии Python/npm, конфликты портов.
- **UI пустой/устаревший:** пересобрать `frontend` и `AiWord`.
- **AI-поиск не отвечает:** проверить `LMSTUDIO_API_BASE`, модель, ключ, сетевую доступность.
- **OCR не работает:** проверить tesseract/poppler и языковые пакеты.
- **Зависают задачи:** проверить очередь, состояние воркеров и логи.

## 8. Что проверить перед передачей в эксплуатацию

- Создан отдельный админ-пользователь.
- Пароли по умолчанию изменены.
- Настроены резервные копии.
- Подтверждена восстановимость из backup.
- Проверены ключевые маршруты: импорт, поиск, AI-поиск, админ-панель.

## 9. Связанные документы

- `docs/deployment.md`
- `docs/architecture.md`
- `docs/admin_handbook.md`
- `docs/readme_ai.md`
- `docs/postgres_migration.md`
